---
description: Инструкция (Workflow) по отладке проблем, когда полигоны или элементы карты не генерируются или не отображаются.
---

# Отладка пайплайна полигонов (Debug Polygon Pipeline)

Используйте этот воркфлоу, если пользователь сообщает о пропаже полигонов, пустой карте или появлении «Красного экрана ошибки».

## 1. Проверка инфраструктуры
Убедитесь, что Redis и Backend работают корректно.

// turbo
1. Проверьте статус контейнеров:
   `docker ps`
2. Проверьте логи Redis на ошибки подключения:
   `docker logs CrazyWalk-Redis`
3. Проверьте логи приложения на наличие «Overpass failed» или «Polygon error»:
   `docker logs CrazyWalk-Frontend`

## 2. Валидация состояния Redis
Полигоны и геометрические данные хранятся в Redis. Поврежденные или пустые ключи могут вызвать сбой фронтенда.

1. Проверьте наличие ключей в Redis:
   `redis-cli keys "game:*"`
2. Если полигоны отсутствуют, проверьте `game:polygons`. Если значение `[]`, генерация не удалась.

## 3. Запуск изолированного теста
Запустите унифицированный генератор для конкретной локации, чтобы увидеть детальную трассировку ошибок.

1. Обновите или проверьте файл `CORE/TEST/debug_gen.py`. Он должен использовать `LocationPolygonsGenerator`:
```python
from CORE.BACKEND.LocationPolygonsGenerator import LocationPolygonsGenerator
gen = LocationPolygonsGenerator()
data = gen.generate_map(32.05688, 34.76878, force_rebuild=True)
print(f"Polygons: {len(data.get('polygons', []))}")
```
2. Запустите тест:
   `python CORE/TEST/debug_gen.py`

## 4. Распространенные проблемы и решения

### Тайм-аут Overpass API
**Симптомы**: В логах ошибка `LocationPolygonsGenerator: Overpass failed.`
**Решение**: 
- Подождите несколько минут (ограничение частоты запросов).
- Проверьте интернет-соединение внутри контейнера.
- Обновите список `servers` в `LocationPolygonsGenerator.py`, добавив свежие зеркала Overpass.

### Ошибка валидации Shapely
**Симптомы**: В логах `Polygon error` или `TopologyException`.
**Решение**:
- Код уже использует `.buffer(0)` для исправления самопересекающихся полигонов.
- Если ошибка сохраняется, проверьте координаты в `game:white_lines` на наличие дубликатов или некорректных точек.

### Отсутствующие соединения
**Симптомы**: Узлы существуют, но полигоны не формируются.
**Решение**:
- Проверьте `target_spacing` в `_create_graph_elements`. Если значение слишком велико, мелкие циклы могут быть пропущены.
- Убедитесь, что у `blue_circles` параметр `active_connections > 0`.

## 5. Принудительная пересборка (Force Rebuild)
Если данные устарели или противоречивы, вызовите полную регенерацию.
1. Очистите кэш Redis:
   `redis-cli del game:meta game:red_lines game:polygons`
2. Обновите страницу карты с новой GPS-локацией.
