<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrazyWalk</title>
    <link rel="icon" type="image/png" href="components/crazywalk_logo.png">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Professional "Bio-Digital" Palette */
            --primary-color: #00ff9d;
            /* Spring Green */
            --secondary-color: #00b8ff;
            /* Electric Cyan */
            --glass-bg: rgba(5, 20, 10, 0.7);
            --glass-border: rgba(0, 255, 157, 0.2);
            --text-glow: 0 0 15px rgba(0, 255, 157, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Poppins', sans-serif;
            color: white;
        }

        .black-square {
            position: absolute;
            width: 42vh;
            height: 72vh;
            background-color: #050505;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
            overflow: hidden;
            border-radius: 3vh;
            /* Rounded corners like a phone screen */
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.15);
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            z-index: 1;
            /* Map Filter: Deep Black BG + Cool Mint/Green Roads 
               Using a hue-rotate around 110deg on sepia creates a nice minty green.
            */
            filter: brightness(2) contrast(1.4) sepia(100%) hue-rotate(110deg) saturate(3.5);
        }

        #loading-gif {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 500;
            background: black;
            transition: opacity 0.6s ease-out;
        }

        /* FULL HEIGHT FLEX CONTAINER */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 4vh 2.5vh 3vh 2.5vh;
            /* Top, Right, Bottom, Left */
            pointer-events: auto;
            /* background: transparent; */
        }

        /* 1. HEADER section */
        .header {
            text-align: center;
            flex-shrink: 0;
            margin-bottom: 1vh;
        }

        .logo-img {
            height: 12vh;
            /* Adjusted size */
            width: auto;
            filter: drop-shadow(0 0 5px rgba(0, 243, 255, 0.8));
            animation: pulse 3s infinite alternate;
            margin-bottom: 1vh;
        }

        @keyframes pulse {
            to {
                transform: scale(1.05);
                filter: drop-shadow(0 0 10px rgba(0, 255, 136, 0.6));
            }
        }

        h1 {
            font-size: 3.2vh;
            font-weight: 800;
            margin: 0.5vh 0 0;
            line-height: 1;
            background: linear-gradient(to right, #fff, #ddd);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h2 {
            font-size: 1.3vh;
            font-weight: 600;
            color: var(--secondary-color);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 0.3vh;
            opacity: 0.9;
        }

        /* 2. MIDDLE SECTION (Menu + Legal) - Flex Grow to take space */
        .middle-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1.5vh;
            width: 100%;
        }

        .menu-links {
            display: flex;
            flex-direction: column;
            gap: 1vh;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 1.5vh;
            padding: 1.2vh 1.5vh;
            border-radius: 1.5vh;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            transition: transform 0.2s, background 0.2s;
            cursor: pointer;
        }

        .menu-item:active {
            transform: scale(0.98);
        }

        .menu-item span {
            font-size: 1.5vh;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .icon-circle {
            width: 3vh;
            height: 3vh;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4vh;
            background: rgba(255, 255, 255, 0.1);
        }

        .icon-info {
            color: var(--primary-color);
        }

        .icon-video {
            color: #ff4757;
        }

        /* Legal - Centered Links */
        .legal-section {
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 2vh;
            margin-bottom: 1vh;
            flex-shrink: 0;
        }

        .legal-item {
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.2vh;
            text-decoration: none;
            transition: color 0.3s;
            position: relative;
        }

        .legal-item::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            bottom: -2px;
            left: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .legal-item:hover {
            color: white;
        }

        .legal-item:hover::after {
            transform: scaleX(1);
        }

        /* 3. BOTTOM ACTIONS */
        .action-buttons {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 1vh;
            margin-top: 0.5vh;
        }

        .btn {
            width: 100%;
            padding: 1.5vh;
            border-radius: 1.5vh;
            font-size: 1.6vh;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-login {
            background: linear-gradient(90deg, #00ff9d 0%, #00b8ff 100%);
            color: black;
            box-shadow: 0 4px 20px rgba(0, 255, 157, 0.4);
            font-weight: 800;
        }

        .btn-guest {
            background: white;
            font-size: 2.0vh;
            font-weight: bold;
            color: black;
            border: 1px solid white;
            backdrop-filter: none;
        }

        /* City Label - Now part of the flex flow */
        #city-label {
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 3vh;
            font-weight: 600;
            letter-spacing: 2px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s;
            text-transform: uppercase;
            margin-top: 6vh;
            /* Spacing from buttons */
        }

        img.iphone-frame {
            height: 100vh;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            pointer-events: none;
            filter: drop-shadow(0 20px 50px rgba(0, 0, 0, 0.9));
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            img.iphone-frame {
                display: none !important;
            }

            .black-square {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                box-shadow: none;
                background-color: black;
            }

            .ui-overlay {
                /* Floating HUD in center, matching desktop size */
                width: 90vh;
                height: 90vh;
                max-width: 100vw;
                /* Safety */
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                padding: 4vh 2.5vh 3vh 2.5vh;
                /* Restore desktop padding */
                border-radius: 3vh;
                /* Optional: smooth corners for the gradient box */
                justify-content: space-between;
                /* Ensure vertical spacing matches desktop */
            }

            /* RESTORED & INCREASED fonts for mobile readability */
            .logo-img {
                height: 15vh;
                /* Larger on mobile */
            }

            h1 {
                font-size: 5vh;
            }

            h2 {
                font-size: 2.5vh;
            }

            .btn {
                font-size: 3vh;
                padding: 2.5vh;
            }

            .menu-item span {
                font-size: 2.5vh;
            }

            .icon-circle {
                width: 5vh;
                height: 5vh;
                font-size: 2.5vh;
            }

            .legal-item {
                font-size: 1.8vh;
            }

            #city-label {
                /* Pin inside the floating overlay or relative to it? 
                   The label is outside ui-overlay in DOM (child of black-square).
                   Since black-square is full screen, city-label is at bottom of SCREEN.
                   To match "same place", we should move it or adjust it.
                   User said "located in the same places". 
                   On desktop, city-label is at bottom of black-square (72vh).
                   On mobile, black-square is 100vh.
                   So city-label is at bottom of screen (100vh).
                   This is probably fine as it leaves the map clear.
                   But if user insists strictly "same place relative to UI",
                   we might need to move it. 
                   "located in the same places in the center of the screen" implies the whole composition.
                   Let's keep city-label at screen bottom for now as it looks better map-wise, 
                   or move it up to 12vh from center bottom?
                   Let's stick to screen bottom for better map visibility and cleaner UI box.
                */
                font-size: 5vh;
                bottom: 12vh;
                /* Lift slightly on mobile */
            }
        }

        /* ERROR SCREEN */
        #error-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ff0033;
            /* Bright Red */
            z-index: 1000;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5vh;
        }

        #error-screen h1 {
            font-size: 4vh;
            color: white;
            background: none;
            -webkit-text-fill-color: white;
            margin-bottom: 2vh;
        }

        #error-screen p {
            font-size: 2vh;
            color: white;
            opacity: 0.9;
            max-width: 80%;
            margin-bottom: 4vh;
        }

        .btn-retry {
            background: white;
            color: #ff0033;
            border: none;
            padding: 1.5vh 4vh;
            font-size: 2vh;
            font-weight: 700;
            border-radius: 1vh;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .btn-retry:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <div class="black-square">
        <div id="map"></div>
        <img id="loading-gif" src="components/earth.gif" alt="Loading...">

        <!-- Red Error Screen -->
        <div id="error-screen">
            <i class="fa-solid fa-triangle-exclamation" style="font-size: 8vh; color: white; margin-bottom: 2vh;"></i>
            <h1>CONNECTION ERROR</h1>
            <p id="error-message">Unable to verify location. <br> Please check your internet or GPS settings.</p>
            <button class="btn-retry" onclick="location.reload()">RETRY</button>
        </div>

        <div class="ui-overlay" id="ui-overlay">
            <div class="header">
                <img src="components/crazywalk_logo.png" class="logo-img" alt="CrazyWalk Logo">
                <h1>CrazyWalk</h1>
                <h2>Walk & Earn Game</h2>
            </div>

            <!-- Middle Section: Grows to fill space -->
            <div class="middle-section">
                <div class="menu-links">
                    <div class="menu-item">
                        <div class="icon-circle icon-info"><i class="fa-solid fa-info"></i></div>
                        <span>Step By Step Instructions</span>
                    </div>
                    <div class="menu-item">
                        <div class="icon-circle icon-video"><i class="fa-solid fa-play"></i></div>
                        <span>Video Explanation</span>
                    </div>
                </div>

            </div>

            <!-- Legal Links Centered Above Login -->
            <div class="legal-section">
                <a href="#" class="legal-item">Terms of Use</a>
                <a href="#" class="legal-item">Privacy Policy</a>
            </div>

            <div class="action-buttons">
                <button class="btn btn-login">LOGIN</button>
                <button class="btn btn-guest">GUEST</button>
            </div>

            <!-- Moved City Label Inside Overlay -->
            <div id="city-label"></div>
        </div>
    </div>
    <img class="iphone-frame" src="components/iphone.png" alt="iphone">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cityLabel = document.getElementById('city-label');
            const mapElement = document.getElementById('map');
            const loadingGif = document.getElementById('loading-gif');
            const uiOverlay = document.getElementById('ui-overlay');
            const errorScreen = document.getElementById('error-screen');
            const errorMessage = document.getElementById('error-message');

            const revealContent = () => {
                loadingGif.style.opacity = '0';
                mapElement.style.opacity = '1'; /* Map full opacity, filters do the darkening */
                cityLabel.style.opacity = '1';
                uiOverlay.style.opacity = '1';
                setTimeout(() => {
                    loadingGif.style.display = 'none';
                }, 600);
            };

            const showError = (msg) => {
                // On mobile, avoid the "Red Screen" and iPhone frame overlay issues
                // Revert to simple alert and show UI so user isn't blocked on black screen
                if (window.innerWidth <= 1024) {
                    const plainMsg = msg.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
                    // Small delay to ensure loading gif doesn't conflict
                    setTimeout(() => {
                        alert(plainMsg);
                    }, 100);
                    revealContent();
                    return;
                }

                loadingGif.style.display = 'none';
                uiOverlay.style.display = 'none';
                mapElement.style.display = 'none';
                errorScreen.style.display = 'flex';
                errorMessage.innerHTML = msg;
            };

            const map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                dragging: false,
                touchZoom: false,
                doubleClickZoom: false,
                scrollWheelZoom: false,
                boxZoom: false,
                keyboard: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                maxZoom: 20,
                subdomains: 'abcd'
            }).addTo(map);

            if ("geolocation" in navigator) {
                loadingGif.style.display = 'block';

                setTimeout(() => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userLat = position.coords.latitude;
                            const userLon = position.coords.longitude;

                            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLon}`)
                                .then(response => {
                                    if (!response.ok) throw new Error("API Network Error");
                                    return response.json();
                                })
                                .then(data => {
                                    const address = data.address;
                                    const city = address.city || address.town || address.village || address.hamlet || address.state || "Unknown City";
                                    cityLabel.textContent = city.toUpperCase();

                                    return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
                                })
                                .then(response => {
                                    if (!response.ok) throw new Error("API Network Error");
                                    return response.json();
                                })
                                .then(searchData => {
                                    let targetLat = userLat;
                                    let targetLon = userLon;

                                    if (searchData && searchData.length > 0) {
                                        targetLat = searchData[0].lat;
                                        targetLon = searchData[0].lon;
                                    }

                                    map.setView([targetLat, targetLon], 17, { animate: false });
                                    revealContent();
                                })
                                .catch(err => {
                                    console.error("Geocoding/Search error:", err);
                                    showError(`Unable to connect to Geolocation API.<br><small>${err.message}</small>`);
                                });
                        },
                        (error) => {
                            console.warn("Geolocation denied or error:", error);
                            // Show red screen if user denied or timeout
                            if (error.code === error.PERMISSION_DENIED) {
                                showError("Location Access Denied.<br>Please enable GPS permissions.");
                            } else if (error.code === error.TIMEOUT) {
                                showError("Location Request Timed Out.<br>Please try again.");
                            } else {
                                showError(`Unable to retrieve location.<br><small>${error.message}</small>`);
                            }
                        },
                        {
                            enableHighAccuracy: false, // Use WiFi/Network (Faster, no GPS needed)
                            timeout: 10000,
                            maximumAge: 60000 // Cache is fine for 1 minute
                        }
                    );
                }, 1000);
            } else {
                showError("Geolocation is not supported<br>by your browser.");
            }
        });
    </script>
</body>

</html>